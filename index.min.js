function parseHash(){var re=/^#(\w+)(\/(\d+))?([?&]accessCode=([0-9a-zA-Z]{4}))?/.exec(location.hash);return re?{shareCode:re[1]||"",fileId:re[3]||"",accessCode:re[5]||""}:{}}function hashUrl(fileId){return param.shareCode?param.shareCode+(fileId?"/"+fileId:"")+(param.accessCode?"?accessCode="+param.accessCode:""):""}var icons={"file-code-o":"xml|html?|haml|php|aspx?|js|(le|sa|s?c)cs|bat|cmd|vbs|java|smali|py","file-archive-o":"zip|rar|gz|7z",android:"apk|jar|dex",apple:"ipa|dmg",windows:"iso|esd|exe|msi","file-text-o":"plain|log|msg|odt|page|te?xt|ext|md|ini|conf|svg","file-audio-o":"aac|mid|wma|ogg|m4a|mp3|ape|flac|wav|d[sd]f","file-image-o":"bmp|jpe?g|png|ico|[tg]if|pc[cx]|tga|exif|fpx|psd|cdr|dxf|ufo|eps|ai|raw|wmf|webp","file-movie-o":"3gp|avi|mkv|mp4|flv|rmvb|mov|wmv","file-word-o":"docx?","file-excel-o":"xl(s[xm]?|t)","file-pdf-o":"pdf",database:"db|sql"};function autoSize(size,digit){var unit=["","K","M","G","T"];var i=Math.floor(Math.log(size)/Math.log(1024));return(size/Math.pow(1024,i)).toFixed(i>0?digit:0)+unit[i]}layui.use(["jquery","layer","table","form"],function(){var $=layui.jquery,layer=layui.layer,table=layui.table,form=layui.form;var parseLayer=function(canClose,msg){return layer.open({title:"天翼云盘解析",type:1,closeBtn:false,shadeClose:canClose,content:$("#tianyi"),btn:canClose?["确定","取消"]:["确定"],success:function(elem,index){if(msg)layer.msg(msg,{shadeClose:true,time:2e3});form.val("tianyi",param)},btn1:function(index,elem){var field=form.val("tianyi");if(field.shareCode==="")return layer.msg("分享链接或id不能为空",{shadeClose:true,time:2e3});var re=/^(((https?:)?\/\/)?([\w-.]+\.)+189\.cn\/t\/)?([0-9a-zA-Z]{12})$/.exec(field.shareCode);if(!re||!re[5])return layer.msg("分享链接或id不正确",{shadeClose:true,time:2e3});window.param={shareCode:re[5],accessCode:field.accessCode};layer.close(index);location.hash=hashUrl("")}})};var refresh=function(){window.param=parseHash();if(!param.shareCode)return parseLayer(false,"请输入正确的分享链接或id");layer.closeAll();if(table.cache.hasOwnProperty("list"))return table.reload("list",{page:{curr:1},where:param});table.render({elem:"#list",url:"TianYi.php",method:"POST",where:$.extend({c:"list"},param),toolbar:"<div>"+'<button type="button" class="layui-btn layui-btn-sm" lay-event="refresh">刷新</button>'+'<button type="button" class="layui-btn layui-btn-sm layui-btn-normal" lay-event="change">更改</button>'+'<button type="button" class="layui-btn layui-btn-sm layui-btn-warm layui-hide" lay-event="multiDown">打包下载</button>'+"</div>",defaultToolbar:["filter","print","exports",{title:"帮助",layEvent:"help",icon:"layui-icon-help"}],height:"full-72",cols:[[{type:"checkbox",title:"全选",width:40,fixed:"left"},{type:"numbers",title:"序号",width:50,fixed:"left"},{field:"fileName",title:"名称",minWidth:160,event:"fileName",templet:function(d){var icon="file-o",ext=d.fileName.replace(/^.*\./,"");if(d.isFolder)icon="folder";else if(ext)$.each(icons,function(k,v){var re=new RegExp("^"+v+"$","i");if(re.test(ext)){icon=k;return false}});return'<i class="fa fa-'+icon+' fa-fw" style="margin-right: 5px;"></i>'+d.fileName},sort:true},{field:"fileSize",title:"大小",width:90,templet:function(d){return d.isFolder?"":autoSize(d.fileSize)},sort:true},{field:"createTime",title:"创建时间",width:165,sort:true,hide:true},{field:"lastOpTime",title:"上次操作时间",width:165,sort:true},{title:"操作",width:85,fixed:"right",templet:function(d){return d.isFolder?"":'<div class="layui-btn-group">'+'<button type="button" lay-event="down" class="layui-btn layui-btn-xs layui-btn-primary" tips="下载"><i class="layui-icon layui-icon-download-circle" style="margin-right: 0px;"></i></button>'+'<button type="button" lay-event="copy" class="layui-btn layui-btn-xs layui-btn-primary" tips="复制链接" data-fileId="'+d.fileId+'"><i class="layui-icon layui-icon-link" style="margin-right: 0px;"></i></button>'+"</div>"},sort:true}]],page:true,limit:30,limits:[20,30,50,80,100,200],done:function(res){if(res.code===0&&res.path)$("#nav").html(function(){var navs=[],len=res.path.length;$.each(res.path,function(i,v){navs.push('<a href="#'+param.shareCode+(i===0?"":"/"+v.fileId)+(param.accessCode?"?accessCode="+param.accessCode:"")+'" data-fileId="'+v.fileId+'">'+(i===len-1?"<cite>"+v.fileName+"</cite>":v.fileName)+"</a>")});return navs.join('<span lay-separator="">/</span>')});else $("#nav").html("<a><cite>根目录</cite></a>");if(res.code<0){setTimeout(function(){parseLayer(false,res.msg)},200)}}})};refresh();table.on("toolbar(list)",function(obj){var event=obj.event;switch(event){case"refresh":refresh();break;case"change":parseLayer(true);break;case"multiDown":var checkStatus=table.checkStatus("list"),checkeds=checkStatus.data,fileIds=[];if(checkeds.length<1)return false;$.each(checkeds,function(i,v){fileIds.push(v.fileId)});window.open(hashUrl(fileIds.join(",")));break;case"help":layer.alert('天翼云直链解析程序由<b style="color:red">QQ：29397395</b>独立开发，调用的全是官方API'+"<hr>解析可能存在解析失败的情况，若解析失败请自行检查文件分享链接或id是否正确，若检查正确后仍解析失败请联系开发者。"+'<hr><b style="color:red">打包下载</b>功能未知原因速度不稳定，不建议使用！'+'<hr>请勿滥用！更新于：<b style="color:red">2021-03-25</b>',{shadeClose:true});break}});table.on("checkbox(list)",function(obj){var checkStatus=table.checkStatus("list");$('.layui-table-tool-temp [lay-event="multiDown"]')[checkStatus.data.length>1?"removeClass":"addClass"]("layui-hide")});table.on("tool(list)",function(obj){var data=obj.data,event=obj.event;switch(event){case"fileName":if(data.isFolder)location.hash=hashUrl(data.fileId);else window.open(hashUrl(data.fileId));break;case"down":window.open(hashUrl(data.fileId));break;case"copy":var url=hashUrl(data.fileId);break}});$('#tianyi textarea[name="shareCode"]').on("input propertychange",function(){var val=$(this).val();if(/^\s+|[\r\n]+/.test(val))$(this).val(val.replace(/^\s+|[\r\n]+/g,""));var re=/^(((https?:)?\/\/)?([\w-.]+\.)+189\.cn\/t\/)?([0-9a-zA-Z]{12})(\s*\(((访问码|密码)\s*:)?\s*([0-9a-zA-Z]{4})\s*\))?/.exec($(this).val());re&&re[5]&&$(this).val(re[5])&&re[9]&&$('#tianyi input[name="accessCode"]').val(re[9])});$('#tianyi input[name="accessCode"]').on("input propertychange",function(){if(/[^0-9a-zA-Z]/.test($(this).val()))$(this).val($(this).val().replace(/[^0-9a-zA-Z]+/g,""))});var tips;$(document).on("mouseenter","[tips]",function(){tips=layer.tips($(this).attr("tips"),$(this),{tips:[1,"#3595CC"],time:0})});$(document).on("mouseleave","[tips]",function(){if(tips){layer.close(tips);tips=null}});$(window).on("hashchange",function(e){refresh()});var clipboard=new ClipboardJS('[lay-event="copy"]',{text:function(elem){var fileId=$(elem).attr("data-fileId");return location.href.replace(/[#?].*$/g,"")+hashUrl(fileId)}});clipboard.on("success",function(e){layer.msg("链接复制成功",{shadeClose:true,time:1500})});clipboard.on("error",function(e){layer.msg(e,{shadeClose:true,time:2e3})})});
